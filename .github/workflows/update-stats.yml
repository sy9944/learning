name: Update Learning Statistics

on:
  issues:
    types: [opened, closed, labeled, unlabeled]
  schedule:
    # æ¯æ—¥åˆå‰9æ™‚ï¼ˆUTCï¼‰ã«å®Ÿè¡Œ
    - cron: '0 9 * * *'
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œå¯èƒ½

jobs:
  update-stats:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: read
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: |
          pip install requests PyGithub
          
      - name: Create update script
        run: |
          cat > update_stats.py << 'EOF'
          import os
          import requests
          from datetime import datetime
          import json
          from github import Github
          
          def get_learning_stats(repo):
              """å­¦ç¿’çµ±è¨ˆã‚’å–å¾—"""
              try:
                  label = repo.get_label('å­¦ç¿’è¨˜éŒ²')
                  issues = repo.get_issues(state='all', labels=[label])
              except:
                  # ãƒ©ãƒ™ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ç©ºã®çµ±è¨ˆã‚’è¿”ã™
                  return {
                      'total_learning_topics': 0,
                      'completed_topics': 0,
                      'in_progress_topics': 0,
                      'categories': {},
                      'this_month_completed': 0,
                      'this_year_completed': 0
                  }
              
              stats = {
                  'total_learning_topics': 0,
                  'completed_topics': 0,
                  'in_progress_topics': 0,
                  'categories': {},
                  'this_month_completed': 0,
                  'this_year_completed': 0
              }
              
              current_year = datetime.now().year
              current_month = datetime.now().month
              
              for issue in issues:
                  stats['total_learning_topics'] += 1
                  
                  # ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ†æ
                  if issue.state == 'closed':
                      stats['completed_topics'] += 1
                      if issue.closed_at:
                          if issue.closed_at.year == current_year:
                              stats['this_year_completed'] += 1
                              if issue.closed_at.month == current_month:
                                  stats['this_month_completed'] += 1
                  else:
                      stats['in_progress_topics'] += 1
                  
                  # ã‚«ãƒ†ã‚´ãƒªåˆ†æ
                  category = 'ãã®ä»–'
                  title = issue.title.lower()
                  if any(word in title for word in ['javascript', 'js', 'react', 'vue', 'css', 'html']):
                      category = 'ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰'
                  elif any(word in title for word in ['python', 'java', 'node', 'go', 'database', 'sql', 'php']):
                      category = 'ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰'
                  elif any(word in title for word in ['docker', 'kubernetes', 'aws', 'gcp', 'ci/cd']):
                      category = 'DevOps'
                  elif any(word in title for word in ['ios', 'android', 'flutter', 'mobile']):
                      category = 'ãƒ¢ãƒã‚¤ãƒ«'
                  elif any(word in title for word in ['algorithm', 'design pattern', 'architecture']):
                      category = 'ãã®ä»–'
                  
                  if category not in stats['categories']:
                      stats['categories'][category] = {'total': 0, 'completed': 0}
                  stats['categories'][category]['total'] += 1
                  if issue.state == 'closed':
                      stats['categories'][category]['completed'] += 1
              
              return stats
          
          def update_readme(stats):
              """README.mdã‚’æ›´æ–°"""
              now = datetime.now().strftime('%Y-%m-%d %H:%M:%S UTC')
              
              readme_lines = [
                  "# ğŸ“ Learning Record System",
                  "",
                  "ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã¨ã—ã¦ã®ç¶™ç¶šå­¦ç¿’ã‚’è¨˜éŒ²ãƒ»å¯è¦–åŒ–ã™ã‚‹ãŸã‚ã®ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã‚·ã‚¹ãƒ†ãƒ ã§ã™ã€‚",
                  "",
                  "## ğŸ“Š å­¦ç¿’çµ±è¨ˆ",
                  "",
                  "### å…¨ä½“ã‚µãƒãƒªãƒ¼",
                  f"- **ç·å­¦ç¿’ãƒˆãƒ”ãƒƒã‚¯æ•°**: {stats['total_learning_topics']}",
                  f"- **å®Œäº†æ¸ˆã¿**: {stats['completed_topics']}",
                  f"- **é€²è¡Œä¸­**: {stats['in_progress_topics']}",
                  f"- **ä»Šæœˆå®Œäº†**: {stats['this_month_completed']}",
                  f"- **ä»Šå¹´å®Œäº†**: {stats['this_year_completed']}",
                  "",
                  "### ã‚«ãƒ†ã‚´ãƒªåˆ¥çµ±è¨ˆ"
              ]
              
              if stats['categories']:
                  for category, data in stats['categories'].items():
                      completion_rate = (data['completed'] / data['total'] * 100) if data['total'] > 0 else 0
                      readme_lines.append(f"- **{category}**: {data['completed']}/{data['total']} ({completion_rate:.1f}%å®Œäº†)")
              else:
                  readme_lines.append("ãƒ‡ãƒ¼ã‚¿ã®è“„ç©ä¸­...")
              
              readme_lines.extend([
                  "",
                  "## ğŸ—‚ï¸ å­¦ç¿’åˆ†é‡",
                  "",
                  "### [Frontend](./frontend/)",
                  "ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰æŠ€è¡“ã®å­¦ç¿’è¨˜éŒ²",
                  "- JavaScript, TypeScript",
                  "- React, Vue.js",
                  "- CSS, UI/UX",
                  "",
                  "### [Backend](./backend/)",
                  "ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰æŠ€è¡“ã®å­¦ç¿’è¨˜éŒ²",
                  "- Node.js, Python, Java, Go",
                  "- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆãƒ»ç®¡ç†",
                  "",
                  "### [DevOps](./devops/)",
                  "DevOpsãƒ»ã‚¤ãƒ³ãƒ•ãƒ©æŠ€è¡“ã®å­¦ç¿’è¨˜éŒ²",
                  "- Docker, Kubernetes",
                  "- CI/CD, AWS, GCP",
                  "",
                  "### [Mobile](./mobile/)",
                  "ãƒ¢ãƒã‚¤ãƒ«ã‚¢ãƒ—ãƒªé–‹ç™ºã®å­¦ç¿’è¨˜éŒ²",
                  "- iOS (Swift), Android (Kotlin)",
                  "- Flutter (Dart)",
                  "",
                  "### [Others](./others/)",
                  "ãã®ä»–ã®æŠ€è¡“ãƒ»ã‚¹ã‚­ãƒ«ã®å­¦ç¿’è¨˜éŒ²",
                  "- ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ãƒ»ãƒ‡ãƒ¼ã‚¿æ§‹é€ ",
                  "- ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³",
                  "- ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£",
                  "",
                  "## ğŸš€ ä½¿ã„æ–¹",
                  "",
                  "1. **æ–°ã—ã„å­¦ç¿’ã‚’é–‹å§‹**: [Issues](../../issues/new?template=learning-record.md)ã‹ã‚‰å­¦ç¿’è¨˜éŒ²ã‚’ä½œæˆ",
                  "2. **é€²æ—ã‚’æ›´æ–°**: Issueä¸Šã§å­¦ç¿’ã®é€²æ—ã‚’éšæ™‚æ›´æ–°",
                  "3. **å®Œäº†æ™‚**: Issueã‚’ã‚¯ãƒ­ãƒ¼ã‚ºã—ã¦å­¦ç¿’å®Œäº†ã‚’ãƒãƒ¼ã‚¯",
                  "",
                  "è©³ç´°ã¯[ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰](./USAGE.md)ã‚’ã”ç¢ºèªãã ã•ã„ã€‚",
                  "",
                  "## ğŸ› ï¸ ã‚·ã‚¹ãƒ†ãƒ æ©Ÿèƒ½",
                  "",
                  "- âœ… æŠ€è¡“åˆ†é‡åˆ¥ã®ãƒ•ã‚©ãƒ«ãƒ€æ§‹é€ ",
                  "- âœ… å­¦ç¿’è¨˜éŒ²ç”¨Issueãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ",
                  "- âœ… è‡ªå‹•çµ±è¨ˆæ›´æ–°ï¼ˆGitHub Actionsï¼‰",
                  "- âœ… é€²æ—å¯è¦–åŒ–ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰",
                  "",
                  "## ğŸ“ˆ æœ€æ–°æ›´æ–°",
                  "",
                  f"æœ€çµ‚æ›´æ–°: {now}",
                  "",
                  "---",
                  "",
                  "> ã“ã®ã‚·ã‚¹ãƒ†ãƒ ã¯å­¦ç¿’ã®ç¶™ç¶šæ€§ã‚’æ”¯æ´ã—ã€æ¡ç”¨æ´»å‹•ã§ã®ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã¨ã—ã¦æ´»ç”¨ã§ãã‚‹ã‚ˆã†è¨­è¨ˆã•ã‚Œã¦ã„ã¾ã™ã€‚"
              ])
              
              return "\n".join(readme_lines)
          
          # ãƒ¡ã‚¤ãƒ³å‡¦ç†
          def main():
              token = os.environ['GITHUB_TOKEN']
              repo_owner = os.environ['REPO_OWNER']
              repo_name = os.environ['REPO_NAME']
              
              g = Github(token)
              repo = g.get_repo(f"{repo_owner}/{repo_name}")
              
              try:
                  # å­¦ç¿’è¨˜éŒ²ãƒ©ãƒ™ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆ
                  try:
                      repo.get_label('å­¦ç¿’è¨˜éŒ²')
                  except:
                      repo.create_label('å­¦ç¿’è¨˜éŒ²', 'e1f5fe', 'å­¦ç¿’è¨˜éŒ²ã«é–¢ã™ã‚‹Issue')
                      
                  try:
                      repo.get_label('é€²è¡Œä¸­')
                  except:
                      repo.create_label('é€²è¡Œä¸­', 'fbca04', 'ç¾åœ¨é€²è¡Œä¸­ã®å­¦ç¿’')
                      
                  # çµ±è¨ˆå–å¾—
                  stats = get_learning_stats(repo)
                  
                  # READMEæ›´æ–°
                  new_readme = update_readme(stats)
                  
                  # ãƒ•ã‚¡ã‚¤ãƒ«æ›´æ–°
                  try:
                      readme_file = repo.get_contents("README.md")
                      repo.update_file("README.md", "ğŸ“Š Update learning statistics [automated]", new_readme, readme_file.sha)
                  except:
                      repo.create_file("README.md", "ğŸ“Š Create learning statistics [automated]", new_readme)
                      
                  print("âœ… Learning statistics updated successfully!")
                  
              except Exception as e:
                  print(f"âŒ Error: {e}")
                  # ã‚¨ãƒ©ãƒ¼ã§ã‚‚ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å¤±æ•—ã•ã›ãªã„
                  pass
          
          if __name__ == "__main__":
              main()
          EOF
          
      - name: Update learning statistics
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
        run: |
          python update_stats.py
          
      - name: Commit changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add README.md
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ğŸ“Š Update learning statistics [automated]"
            git push
          fi