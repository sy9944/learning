name: Update Learning Statistics

on:
  issues:
    types: [opened, closed, labeled, unlabeled]
  schedule:
    # æ¯Žæ—¥åˆå‰9æ™‚ï¼ˆUTCï¼‰ã«å®Ÿè¡Œ
    - cron: '0 9 * * *'
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œå¯èƒ½

jobs:
  update-stats:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: |
          pip install requests PyGithub
          
      - name: Create update script
        run: |
          cat > update_stats.py << 'EOF'
          import os
          import requests
          from datetime import datetime
          import json
          from github import Github
          
          def get_learning_stats(repo):
              """æŠ€è¡“ãƒ©ãƒ™ãƒ«ã”ã¨ã«Issueã‚’é›†è¨ˆã—çµ±è¨ˆæƒ…å ±ã‚’ç”Ÿæˆ"""
              issues = repo.get_issues(state='all')
              stats = {
                  'total_learning_topics': 0,
                  'completed_topics': 0,
                  'in_progress_topics': 0,
                  'labels': {}, # ãƒ©ãƒ™ãƒ«ã”ã¨ã®é›†è¨ˆ
                  'this_month_completed': 0,
                  'this_year_completed': 0
              }
              
              current_year = datetime.now().year
              current_month = datetime.now().month
              
              for issue in issues:
                  stats['total_learning_topics'] += 1
                  
                  # ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ†æž
                  if issue.state == 'closed':
                      stats['completed_topics'] += 1
                      if issue.closed_at:
                          if issue.closed_at.year == current_year:
                              stats['this_year_completed'] += 1
                              if issue.closed_at.month == current_month:
                                  stats['this_month_completed'] += 1
                  else:
                      stats['in_progress_topics'] += 1
                  
                  # ãƒ©ãƒ™ãƒ«åˆ†æž
                  for label in issue.labels:
                    label_name = label.name
                    if label_name not in stats['labels']:
                        stats['labels'][label_name] = {'total': 0, 'completed': 0}
                    stats['labels'][label_name]['total'] += 1
                    if issue.state == 'closed':
                        stats['labels'][label_name]['completed'] += 1
                        
              return stats
          
          def update_readme(stats):
              """README.mdã‚’æ›´æ–°"""
              now = datetime.now().strftime('%Y-%m-%d %H:%M:%S UTC')
              
              readme_lines = [
                  "## ðŸ“Š å­¦ç¿’çµ±è¨ˆ",
                  "",
                  "### å…¨ä½“ã‚µãƒžãƒªãƒ¼",
                  f"- **ç·å­¦ç¿’ãƒˆãƒ”ãƒƒã‚¯æ•°**: {stats['total_learning_topics']}",
                  f"- **å®Œäº†æ¸ˆã¿**: {stats['completed_topics']}",
                  f"- **é€²è¡Œä¸­**: {stats['in_progress_topics']}",
                  f"- **ä»Šæœˆå®Œäº†**: {stats['this_month_completed']}",
                  f"- **ä»Šå¹´å®Œäº†**: {stats['this_year_completed']}",
                  "",
                  "### æŠ€è¡“åˆ¥çµ±è¨ˆ"
              ]
              
              if stats['labels']:
                  for label, data in stats['labels'].items():
                      completion_rate = (data['completed'] / data['total'] * 100) if data['total'] > 0 else 0
                      readme_lines.append(f"- **{label}**: {data['completed']}/{data['total']} ({completion_rate:.1f}%å®Œäº†)")
              else:
                  readme_lines.append("ãƒ‡ãƒ¼ã‚¿ã®è“„ç©ä¸­...")
              
              readme_lines.extend([
                  "## ðŸ“ˆ æœ€æ–°æ›´æ–°",
                  "",
                  f"æœ€çµ‚æ›´æ–°: {now}",
              ])
              
              return "\n".join(readme_lines)
          
          # ãƒ¡ã‚¤ãƒ³å‡¦ç†
          def main():
              token = os.environ['GITHUB_TOKEN']
              repo_owner = os.environ['REPO_OWNER']
              repo_name = os.environ['REPO_NAME']
              
              g = Github(token)
              repo = g.get_repo(f"{repo_owner}/{repo_name}")
              
              try:
                  # çµ±è¨ˆå–å¾—
                  stats = get_learning_stats(repo)
                  
                  # READMEæ›´æ–°
                  new_readme = update_readme(stats)
                  
                  # ãƒ•ã‚¡ã‚¤ãƒ«æ›´æ–°
                  try:
                      readme_file = repo.get_contents("README.auto.md")
                      repo.update_file("README.auto.md", "ðŸ“Š Update learning statistics [automated]", new_readme, readme_file.sha)
                  except:
                      repo.create_file("README.auto.md", "ðŸ“Š Create learning statistics [automated]", new_readme)
                      
                  print("âœ… Learning statistics updated successfully!")
                  
              except Exception as e:
                  print(f"âŒ Error: {e}")
                  # ã‚¨ãƒ©ãƒ¼ã§ã‚‚ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å¤±æ•—ã•ã›ãªã„
                  pass
          
          if __name__ == "__main__":
              main()
          EOF
          
      - name: Update learning statistics
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
        run: |
          python update_stats.py

      - name: Combine README files
        run: |
          cat README.manual.md >> README.md
          cat README.auto.md >> README.md
          
      - name: Commit changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add README.md README.auto.md
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ðŸ“Š Update learning statistics [automated]"
            git pull --rebase
            git push
          fi